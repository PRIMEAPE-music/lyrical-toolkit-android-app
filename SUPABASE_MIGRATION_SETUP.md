# Supabase Migration Setup Guide

This guide covers the migration from Netlify Blobs to Supabase for persistent song storage in the Lyrical Toolkit.

## Files Updated

### Backend Functions
- `netlify/functions/songs.js` - Main song CRUD operations (list, bulk save/update, delete all)
- `netlify/functions/song-content.js` - Individual song operations (get, create, update, delete)
- `netlify/functions/supabase-client.js` - Supabase client configuration (existing)

### Database Schema
- `database/songs_schema.sql` - Supabase database schema for songs storage

### Frontend Services
- `src/services/songsService.js` - Updated with example song support
- `src/utils/songStorage.js` - Updated to work with Supabase endpoints and include example song logic

### Components
- Example song badge already implemented in `src/components/Tabs/UploadTab.js`

## Database Setup

1. **Run the SQL Schema**:
   Execute the contents of `database/songs_schema.sql` in your Supabase SQL editor to create:
   - `songs` table with proper columns and indexes
   - `song_metadata` table for additional metadata
   - Row Level Security (RLS) policies
   - Automatic timestamp triggers

2. **Environment Variables**:
   Ensure these are set in your Netlify environment:
   ```
   SUPABASE_URL=your_supabase_url
   SUPABASE_SERVICE_KEY=your_supabase_service_key
   ```

## Key Features Implemented

### Song Storage
- **Persistent Storage**: Songs are now stored in Supabase database instead of Netlify Blobs
- **User Isolation**: RLS policies ensure users can only access their own songs
- **Metadata Tracking**: Automatic word count, line count, and timestamp tracking

### Example Song Support
- **HUMAN.txt Example**: The public/HUMAN.txt file is automatically shown for users with no songs
- **Example Badge**: Songs marked as examples display a blue "Example" badge
- **Automatic Removal**: Example song disappears when users upload their own content

### API Compatibility
- **Backward Compatibility**: Frontend components continue to work without changes
- **Data Transformation**: Backend transforms Supabase format to expected frontend format
- **Error Handling**: Graceful fallback to example song on auth/service errors

## Database Schema Details

### Songs Table
```sql
songs (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    filename TEXT,
    word_count INTEGER,
    line_count INTEGER,
    date_added TIMESTAMP WITH TIME ZONE,
    date_modified TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE,
    updated_at TIMESTAMP WITH TIME ZONE
)
```

### Indexes
- `idx_songs_user_id` - Fast user song lookups
- `idx_songs_date_added` - Chronological ordering
- `idx_songs_date_modified` - Last modified sorting
- `idx_songs_title` - Title-based searches

## API Endpoints

### Songs Management (`/.netlify/functions/songs`)
- `GET` - List user's songs (metadata only)
- `PUT` - Bulk save/update songs
- `DELETE` - Clear all user's songs

### Individual Songs (`/.netlify/functions/song-content/{id}`)
- `GET` - Get specific song with content
- `POST` - Create new song with specific ID
- `PUT` - Update existing song
- `DELETE` - Delete specific song

## Testing Checklist

### Database Operations
- [ ] User can upload songs and they persist in database
- [ ] Songs are properly isolated by user (RLS working)
- [ ] Word count and line count are calculated correctly
- [ ] Timestamps are set properly on create/update

### Example Song Logic
- [ ] New users see HUMAN.txt as example song
- [ ] Example song shows "Example" badge
- [ ] Example song disappears when user uploads their own songs
- [ ] Example song shows on auth errors/service unavailable

### CRUD Operations
- [ ] Create: Upload new songs via drag/drop or file picker
- [ ] Read: View song list and individual song content
- [ ] Update: Edit songs via notepad and save changes
- [ ] Delete: Remove individual songs or clear all songs

### Authentication Integration
- [ ] Authenticated users can save/load songs from database
- [ ] Unauthenticated users see example song only
- [ ] Token refresh works correctly
- [ ] Logout clears song list

### Error Handling
- [ ] Database connection errors show appropriate messages
- [ ] Network errors gracefully degrade to example song
- [ ] Invalid song IDs return 404 errors
- [ ] Unauthorized access returns 401 errors

## Migration Notes

- **No Data Migration Required**: This is a fresh implementation
- **URL Changes**: API endpoints now point to `.netlify/functions/` instead of Express server
- **ID Format**: Song IDs are now UUIDs generated by Supabase instead of timestamp-based
- **Content Field**: Songs use `content` field instead of `lyrics` (backward compatible)

## Development vs Production

### Development
- API URL: `http://localhost:8888/.netlify/functions/songs`
- Uses Netlify Dev server for functions

### Production
- API URL: `/.netlify/functions/songs`
- Uses deployed Netlify functions

## Troubleshooting

### Common Issues

1. **Songs not persisting**: Check Supabase environment variables
2. **RLS errors**: Verify user authentication and RLS policies
3. **Example song not loading**: Check public/HUMAN.txt file exists
4. **API errors**: Check network tab for detailed error messages

### Debug Steps

1. Check browser console for errors
2. Verify Supabase connection in function logs
3. Test API endpoints directly with curl/Postman
4. Verify user authentication tokens
5. Check Supabase dashboard for data

## Performance Considerations

- Songs are loaded on demand (metadata first, content when needed)
- Example song is cached after first load
- Database queries are optimized with proper indexes
- RLS policies are designed for performance

## Security Features

- Row Level Security prevents unauthorized data access
- JWT token validation on all endpoints
- Input sanitization with DOMPurify
- Parameterized queries prevent SQL injection
- CORS headers configured properly